name: Build and Publish Python package

on:
    push:
        branches:
            - 'DEVOPS-425'
env:
    PACKAGE_NAME: ${{ github.repository }}
    VERSION: '0.1.0'
    BRANCH_NAME: ${{ github.ref }}
    BUILD_NUMBER: '12'
    ARCHIVE_NAME: "$PACKAGE_NAME-$VERSION-$BRANCH_NAME-$BUILD_NUMBER"

jobs:
    create-conda-recipe:
        runs-on: ubuntu-latest
        steps:
        -   name: Checkout code
            uses: actions/checkout@v3
        -   name: Install grayskull
            run: |
                python -m pip install grayskull
        -   name: Archive my repository
            run: |
                git archive --format=tar.gz HEAD > "$ARCHIVE_NAME.tar.gz"
        -   name: Create conda recipe
            run: |
                grayskull pypi --strict-conda-forge "$ARCHIVE_NAME.tar.gz"

    build-conda-package:
        runs-on: ubuntu-latest
        needs: create-conda-recipe
        steps:
        -   name: Build conda package
            run: |
                output=$(conda build $PACKAGE_NAME --output)
        -   name: Publish conda package
            run: |
                curl -u $ARTIFACTORY_USER:$ARTIFACTORY_PASSWORD -T $output "https://mirageoscienceltd.jfrog.io/artifactory/dev/$PACKAGE_NAME/$VERSION/$ARCHIVE_NAME.tar.bz2"

         
